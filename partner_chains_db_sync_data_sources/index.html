<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Crate providing implementations of Partner Chain Data Sources that read from Db-Sync Postgres."><title>partner_chains_db_sync_data_sources - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2"href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-e56847b5.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="partner_chains_db_sync_data_sources" data-themes="" data-resource-suffix="" data-rustdoc-version="1.91.0-nightly (f2824da98 2025-08-28)" data-channel="nightly" data-search-js="search-03d23683.js" data-stringdex-js="stringdex-0e748618.js" data-settings-js="settings-c38705f0.js" ><script src="../static.files/storage-e2aeef58.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-6dc2a7f3.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-263c88ec.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-eab170b8.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><rustdoc-topbar><h2><a href="#">Crate partner_chains_db_sync_data_sources</a></h2></rustdoc-topbar><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../partner_chains_db_sync_data_sources/index.html">partner_<wbr>chains_<wbr>db_<wbr>sync_<wbr>data_<wbr>sources</a><span class="version">1.7.0</span></h2></div><div class="sidebar-elems"><ul class="block"><li><a id="all-types" href="all.html">All Items</a></li></ul><section id="rustdoc-toc"><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#usage" title="Usage">Usage</a><ul><li><a href="#adding-to-the-node" title="Adding to the node">Adding to the node</a></li><li><a href="#cardano-db-sync-configuration" title="Cardano DB Sync configuration">Cardano DB Sync configuration</a></li><li><a href="#custom-indexes" title="Custom Indexes">Custom Indexes</a></li></ul></li></ul><h3><a href="#macros">Crate Items</a></h3><ul class="block"><li><a href="#macros" title="Macros">Macros</a></li><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#enums" title="Enums">Enums</a></li><li><a href="#functions" title="Functions">Functions</a></li><li><a href="#types" title="Type Aliases">Type Aliases</a></li></ul></section><div id="rustdoc-modnav"></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><section id="main-content" class="content"><div class="main-heading"><h1>Crate <span>partner_<wbr>chains_<wbr>db_<wbr>sync_<wbr>data_<wbr>sources</span>&nbsp;<button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/partner_chains_db_sync_data_sources/lib.rs.html#1-219">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Crate providing implementations of Partner Chain Data Sources that read from Db-Sync Postgres.</p>
<h2 id="usage"><a class="doc-anchor" href="#usage">§</a>Usage</h2><h3 id="adding-to-the-node"><a class="doc-anchor" href="#adding-to-the-node">§</a>Adding to the node</h3>
<p>All data sources defined in this crate require a Postgres connection pool <a href="type.PgPool.html" title="type partner_chains_db_sync_data_sources::PgPool">PgPool</a> to run
queries, which should be shared between all data sources. For convenience, this crate provides
a helper function <a href="fn.get_connection_from_env.html" title="fn partner_chains_db_sync_data_sources::get_connection_from_env">get_connection_from_env</a> that will create a connection pool based on
configuration read from node environment.</p>
<p>Each data source also accepts an optional Prometheus metrics client <a href="struct.McFollowerMetrics.html" title="struct partner_chains_db_sync_data_sources::McFollowerMetrics">McFollowerMetrics</a> for
reporting metrics to the Substrate’s Prometheus metrics service. This client can be obtained
using the <a href="fn.register_metrics_warn_errors.html" title="fn partner_chains_db_sync_data_sources::register_metrics_warn_errors">register_metrics_warn_errors</a> function.</p>
<p>In addition to these two common arguments, some data sources depend on <a href="struct.BlockDataSourceImpl.html" title="struct partner_chains_db_sync_data_sources::BlockDataSourceImpl">BlockDataSourceImpl</a>
which provides basic queries about blocks, and additional configuration for their data cache
size.</p>
<p>An example node code that creates the data sources can look like the following:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>partner_chains_db_sync_data_sources::<span class="kw-2">*</span>;

<span class="kw">pub const </span>CANDIDATES_FOR_EPOCH_CACHE_SIZE: usize = <span class="number">64</span>;
<span class="kw">pub const </span>STAKE_CACHE_SIZE: usize = <span class="number">100</span>;
<span class="kw">pub const </span>GOVERNED_MAP_CACHE_SIZE: u16 = <span class="number">100</span>;

<span class="kw">async fn </span>create_data_sources(
    metrics_registry_opt: <span class="prelude-ty">Option</span>&lt;<span class="kw-2">&amp;</span>substrate_prometheus_endpoint::Registry&gt;
) -&gt; <span class="prelude-ty">Result</span>&lt;(), Box&lt;<span class="kw">dyn </span>std::error::Error + Send + Sync&gt;&gt; {
    <span class="kw">let </span>metrics = register_metrics_warn_errors(metrics_registry_opt);
    <span class="kw">let </span>pool = get_connection_from_env().<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="comment">// Block data source is shared by others for cache reuse
    </span><span class="kw">let </span>block = Arc::new(BlockDataSourceImpl::new_from_env(pool.clone()).<span class="kw">await</span><span class="question-mark">?</span>);

    <span class="kw">let </span>sidechain_rpc = SidechainRpcDataSourceImpl::new(block.clone(), metrics.clone());

    <span class="kw">let </span>mc_hash = Arc::new(McHashDataSourceImpl::new(block.clone(), metrics.clone()));

    <span class="kw">let </span>authority_selection =
        CandidatesDataSourceImpl::new(pool.clone(), metrics.clone())
    	.<span class="kw">await</span><span class="question-mark">?
    	</span>.cached(CANDIDATES_FOR_EPOCH_CACHE_SIZE)<span class="question-mark">?</span>;

    <span class="kw">let </span>native_token =
        NativeTokenManagementDataSourceImpl::new_from_env(pool.clone(), metrics.clone()).<span class="kw">await</span><span class="question-mark">?</span>;

    <span class="kw">let </span>block_participation =
    	StakeDistributionDataSourceImpl::new(pool.clone(), metrics.clone(), STAKE_CACHE_SIZE);

    <span class="kw">let </span>governed_map =
        GovernedMapDataSourceCachedImpl::new(pool, metrics.clone(), GOVERNED_MAP_CACHE_SIZE, block).<span class="kw">await</span><span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(())
}</code></pre></div>
<h3 id="cardano-db-sync-configuration"><a class="doc-anchor" href="#cardano-db-sync-configuration">§</a>Cardano DB Sync configuration</h3>
<p>Partner Chains data sources require specific Db-Sync configuration to be set for them to
operate correctly:</p>
<ul>
<li><code>insert_options.tx_out.value</code>: must be either <code>"enable"</code> (default) or <code>"consumed"</code>.
The data sources in this crate that need to query transaction intputs automatically detect
which option is used and adjust their queries accordingly. This requires the database to be
already initialized by db-sync. When run for an uninitialized database, the data sources
will default to the <code>"enable"</code> option.</li>
<li><code>insert_options.tx_out.use_address_table</code>: must be <code>false</code> (default).</li>
<li><code>insert_options.ledger</code>: must be <code>"enable"</code> (default).</li>
<li><code>insert_options.multi_asset</code>: must be <code>true</code> (default).</li>
<li><code>insert_options.governance</code>: must <code>"enable"</code> (default).</li>
<li><code>insert_options.remove_jsonb_from_schema</code>: must be <code>"disable"</code> (default).</li>
<li><code>insert_options.plutus</code>: must be <code>"enable"</code> (default).</li>
</ul>
<p>The default Cardano DB Sync configuration meets these requirements, so Partner Chain node
operators that do not wish to use any custom configuration can use the defaults, otherwise
they must preserve the values described above. See <a href="https://github.com/IntersectMBO/cardano-db-sync/blob/master/doc/configuration.md">Db-Sync configuration docs</a> for more
information.</p>
<h3 id="custom-indexes"><a class="doc-anchor" href="#custom-indexes">§</a>Custom Indexes</h3>
<p>In addition to indexes automatically created by Db-Sync itself, data sources in this crate
require additional ones to be created for some of the queries to execute efficiently. These
indexes are:</p>
<ul>
<li><code>idx_ma_tx_out_ident ON ma_tx_out(ident)</code></li>
<li><code>idx_tx_out_address ON tx_out USING hash (address)</code></li>
</ul>
<p>The data sources in this crate automatically create these indexes when needed at node startup.</p>
</div></details><h2 id="macros" class="section-header">Macros<a href="#macros" class="anchor">§</a></h2><dl class="item-table"><dt><a class="macro" href="macro.observed_async_trait.html" title="macro partner_chains_db_sync_data_sources::observed_async_trait">observed_<wbr>async_<wbr>trait</a></dt><dd>Logs each method invocation and each returned result.
Has to be made at the level of trait, because otherwise #<a href="https://docs.rs/async-trait/0.1.88/async_trait/index.html" title="mod async_trait">async_trait</a> is expanded first.
‘&amp;self’ matching yields “__self” identifier not found error, so “&amp;$self:tt” is required.
Works only if return type is Result.</dd></dl><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.BlockDataSourceImpl.html" title="struct partner_chains_db_sync_data_sources::BlockDataSourceImpl">Block<wbr>Data<wbr>Source<wbr>Impl</a></dt><dd>Db-Sync data source that queries Cardano block information</dd><dt><a class="struct" href="struct.CandidatesDataSourceImpl.html" title="struct partner_chains_db_sync_data_sources::CandidatesDataSourceImpl">Candidates<wbr>Data<wbr>Source<wbr>Impl</a></dt><dd>Db-Sync data source serving data for Partner Chain committee selection</dd><dt><a class="struct" href="struct.ConnectionConfig.html" title="struct partner_chains_db_sync_data_sources::ConnectionConfig">Connection<wbr>Config</a></dt><dd>Postgres connection config used when creating a <a href="type.PgPool.html" title="type partner_chains_db_sync_data_sources::PgPool">PgPool</a>.</dd><dt><a class="struct" href="struct.DbSyncBlockDataSourceConfig.html" title="struct partner_chains_db_sync_data_sources::DbSyncBlockDataSourceConfig">DbSync<wbr>Block<wbr>Data<wbr>Source<wbr>Config</a></dt><dd>Configuration for <a href="struct.BlockDataSourceImpl.html" title="struct partner_chains_db_sync_data_sources::BlockDataSourceImpl">BlockDataSourceImpl</a></dd><dt><a class="struct" href="struct.GovernedMapDataSourceCachedImpl.html" title="struct partner_chains_db_sync_data_sources::GovernedMapDataSourceCachedImpl">Governed<wbr>MapData<wbr>Source<wbr>Cached<wbr>Impl</a></dt><dd>Cached data source serving the Governed Map feature of Partner Chains toolkit</dd><dt><a class="struct" href="struct.GovernedMapDataSourceImpl.html" title="struct partner_chains_db_sync_data_sources::GovernedMapDataSourceImpl">Governed<wbr>MapData<wbr>Source<wbr>Impl</a></dt><dd>Data source for the Governed Map feature of Partner Chains toolkit</dd><dt><a class="struct" href="struct.McFollowerMetrics.html" title="struct partner_chains_db_sync_data_sources::McFollowerMetrics">McFollower<wbr>Metrics</a></dt><dd>Substrate Prometheus metrics client used by Partner Chain data sources</dd><dt><a class="struct" href="struct.McHashDataSourceImpl.html" title="struct partner_chains_db_sync_data_sources::McHashDataSourceImpl">McHash<wbr>Data<wbr>Source<wbr>Impl</a></dt><dd>Db-Sync data source used by the Main Chain Reference feature of Partner Chain toolkit.</dd><dt><a class="struct" href="struct.NativeTokenManagementDataSourceImpl.html" title="struct partner_chains_db_sync_data_sources::NativeTokenManagementDataSourceImpl">Native<wbr>Token<wbr>Management<wbr>Data<wbr>Source<wbr>Impl</a></dt><dd>Db-Sync data source for the Native Token Management feature of the Partner Chains toolkit.</dd><dt><a class="struct" href="struct.SidechainRpcDataSourceImpl.html" title="struct partner_chains_db_sync_data_sources::SidechainRpcDataSourceImpl">Sidechain<wbr>RpcData<wbr>Source<wbr>Impl</a></dt><dd>Db-Sync data source serving basic Cardano block data</dd><dt><a class="struct" href="struct.SqlxError.html" title="struct partner_chains_db_sync_data_sources::SqlxError">Sqlx<wbr>Error</a></dt><dd>Wrapper error type for [sqlx::Error]</dd><dt><a class="struct" href="struct.StakeDistributionDataSourceImpl.html" title="struct partner_chains_db_sync_data_sources::StakeDistributionDataSourceImpl">Stake<wbr>Distribution<wbr>Data<wbr>Source<wbr>Impl</a></dt><dd>Db-Sync data source serving data about Cardano delegations</dd></dl><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><dl class="item-table"><dt><a class="enum" href="enum.DataSourceError.html" title="enum partner_chains_db_sync_data_sources::DataSourceError">Data<wbr>Source<wbr>Error</a></dt><dd>Error type returned by Db-Sync based data sources</dd></dl><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><dl class="item-table"><dt><a class="fn" href="fn.get_connection_from_env.html" title="fn partner_chains_db_sync_data_sources::get_connection_from_env">get_<wbr>connection_<wbr>from_<wbr>env</a></dt><dd>Returns a Postgres connection pool constructed using configuration read from environment</dd><dt><a class="fn" href="fn.register_metrics_warn_errors.html" title="fn partner_chains_db_sync_data_sources::register_metrics_warn_errors">register_<wbr>metrics_<wbr>warn_<wbr>errors</a></dt><dd>Registers new metrics with Substrate Prometheus metrics service and returns a client instance</dd></dl><h2 id="types" class="section-header">Type Aliases<a href="#types" class="anchor">§</a></h2><dl class="item-table"><dt><a class="type" href="type.PgPool.html" title="type partner_chains_db_sync_data_sources::PgPool">PgPool</a></dt><dd>An alias for [<code>Pool</code>][crate::pool::Pool], specialized for Postgres.</dd></dl></section></div></main></body></html>