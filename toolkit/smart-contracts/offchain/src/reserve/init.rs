//! Initialization of the reserve management is execution of two similar transaction to
//! initialize two scripts: Reserve Management Validator and Reserve Management Policy
//!
//! Transaction for each of these scripts should have:
//! * an output to Version Oracle Validator address that should:
//! * * have script reference with the script being initialized attached, script should be applied with Version Oracle Policy Id
//! * * contain 1 token of Version Oracle Policy with "Version oracle" asset name, minted in this transaction
//! * * * mint redeemer should be Constr(1, [Int: SCRIPT_ID, Bytes: Applied Script Hash])
//! * * have Plutus Data that is [Int: SCRIPT_ID, Bytes: Version Oracle Policy Id]
//! * an output to the current governance (holder of governance token) that should:
//! * * contain a new Governance Policy token, minted in this transaction,
//! * * * mint redeemer should be empty constructor Plutus Data
//! * a script reference input of the current Governance UTXO
//! * signature of the current governance

use crate::{
	await_tx::AwaitTx,
	cardano_keys::CardanoPaymentSigningKey,
	csl::TransactionContext,
	multisig::MultiSigSmartContractResult,
	plutus_script, plutus_script_v3, scripts_data,
	versioning_system::{ScriptData, initialize_script},
};
use hex_literal::hex;
use ogmios_client::{
	query_ledger_state::{QueryLedgerState, QueryUtxoByUtxoId},
	query_network::QueryNetwork,
	transactions::Transactions,
};
use raw_scripts::{RESERVE_AUTH_POLICY, RawScript, ScriptId};
use sidechain_domain::UtxoId;

/// Stores smart contracts used for reserve management in the versioning system.
/// Scripts stored are:
///  - Reserve Management Validator
///  - Reserve Management Policy
///  - Illiquid Circulation Supply Validator
///  - Illiquid Circulation Auth Token Policy
pub async fn init_reserve_management<
	T: QueryLedgerState + Transactions + QueryNetwork + QueryUtxoByUtxoId,
	A: AwaitTx,
>(
	genesis_utxo: UtxoId,
	payment_key: &CardanoPaymentSigningKey,
	client: &T,
	await_tx: &A,
) -> anyhow::Result<Vec<MultiSigSmartContractResult>> {
	let payment_ctx = TransactionContext::for_payment_key(payment_key, client).await?;
	let version_oracle = scripts_data::version_oracle(genesis_utxo, payment_ctx.network)?;

	let reserve_validator_raw_script = RawScript(&hex!(
		"591dff010100229800aba4aba2aba1aba0aab9faab9eaab9dab9cab9a9bae0024888888888a60022a6600692013165787065637420726573657276655f6f75747075745f646174756d3a2057696b7361203d206f75747075745f646174756d00168a99801a493465787065637420496e6c696e65446174756d286f75747075745f646174756d29203d206f75747075745f7574786f2e646174756d00168a99801a4926657870656374205b6f75747075745f7574786f5d203d20726573657276655f6f75747075747300168a99801a49ff657870656374205b676f7665726e616e63655265666572656e6365496e7075745d203d0a2020202020202020202073656c662e7265666572656e63655f696e707574730a2020202020202020202020207c3e206c6973742e66696c746572280a20202020202020202020202020202020666e28696e70757429207b0a2020202020202020202020202020202020206c6574206f7574707574203d20696e7075742e6f75747075740a2020202020202020202020202020202020206c6574206861735f746f6b656e203d0a20202020202020202020202020202020202020206173736574732e746f5f64696374286f75747075742e76616c7565290a20202020ff2020202020202020202020202020202020207c3e20646963742e6765742876657273696f6e5f6f7261636c655f636f6e666967290a202020202020202020202020202020202020202020207c3e206f7074696f6e2e616e645f7468656e28646963742e676574285f2c202256657273696f6e206f7261636c652229290a202020202020202020202020202020202020202020207c3e206f7074696f6e2e69735f736f6d6528290a0a2020202020202020202020202020202020207768656e206f75747075742e646174756d206973207b0a2020202020202020202020202020202020202020496e6c696e65446174756d286461746129202d3e207b0a202020ff2020202020202020202020202020202020202020206966206461746120697320646174756d3a2056657273696f6e696e67446174756d207b0a2020202020202020202020202020202020202020202020206861735f746f6b656e20262620646174756d2e7363726970744964203d3d2033320a202020202020202020202020202020202020202020207d20656c7365207b0a20202020202020202020202020202020202020202020202046616c73650a202020202020202020202020202020202020202020207d0a202020202020202020202020202020202020202020207d0a20202020202020202020202020202020202020205f202d3e2046616c73650a362020202020202020202020202020202020207d0a202020202020202020202020202020207d2c0a20202020202020202020202020202900168a99801a49ff657870656374205b6f75747075745f6963735f7574786f5d203d0a20202020202020202020202020202020202073656c662e6f7574707574730a20202020202020202020202020202020202020207c3e206c6973742e66696c746572280a202020202020202020202020202020202020202020202020666e286f757470757429207b0a20202020202020202020202020202020202020202020202020206c65742061646472203d206f75747075742e616464726573730a2020202020202020202020202020202020202020202020202020616464722e7061796d656e745f63726564656e7469616c203d3d20536372697074280a2020202020202020202020882020202020202020202020202020202020696c6c69717569645f63697263756c6174696f6e5f737570706c795f7363726970745f686173682c0a2020202020202020202020202020202020202020202020202020290a2020202020202020202020202020202020202020202020207d2c0a202020202020202020202020202020202020202020202900168a99801a49ff657870656374205b696c6c697175696443697263756c6174696f6e537570706c795265666572656e6365496e7075745d203d0a2020202020202020202073656c662e7265666572656e63655f696e707574730a2020202020202020202020207c3e206c6973742e66696c746572280a20202020202020202020202020202020666e28696e70757429207b0a2020202020202020202020202020202020206c6574206f7574707574203d20696e7075742e6f75747075740a2020202020202020202020202020202020206c6574206861735f746f6b656e203d0a20202020202020202020202020202020202020206173736574732e746f5f64696374286f7574ff7075742e76616c7565290a202020202020202020202020202020202020202020207c3e20646963742e6765742876657273696f6e5f6f7261636c655f636f6e666967290a202020202020202020202020202020202020202020207c3e206f7074696f6e2e616e645f7468656e28646963742e676574285f2c202256657273696f6e206f7261636c652229290a202020202020202020202020202020202020202020207c3e206f7074696f6e2e69735f736f6d6528290a0a2020202020202020202020202020202020207768656e206f75747075742e646174756d206973207b0a2020202020202020202020202020202020202020496e6c696e65446174756dff286461746129202d3e207b0a2020202020202020202020202020202020202020202020206966206461746120697320646174756d3a2056657273696f6e696e67446174756d207b0a2020202020202020202020202020202020202020202020206861735f746f6b656e20262620646174756d2e7363726970744964203d3d2033300a202020202020202020202020202020202020202020207d20656c7365207b0a20202020202020202020202020202020202020202020202046616c73650a202020202020202020202020202020202020202020207d0a202020202020202020202020202020202020202020207d0a2020202020202020202020202020202045202020205f202d3e2046616c73650a2020202020202020202020202020202020207d0a202020202020202020202020202020207d2c0a20202020202020202020202020202900168a99801a492f65787065637420726573657276655f696e7075745f646174756d3a2057696b7361203d20696e7075745f646174756d00168a99801a49ff657870656374205b7265736572766541757468546f6b656e5265666572656e6365496e7075745d203d0a20202020202073656c662e7265666572656e63655f696e707574730a20202020202020207c3e206c6973742e66696c746572280a202020202020202020202020666e28696e70757429207b0a20202020202020202020202020206c6574206f7574707574203d20696e7075742e6f75747075740a20202020202020202020202020206c6574206861735f746f6b656e203d0a202020202020202020202020202020206173736574732e746f5f64696374286f75747075742e76616c7565290a2020202020202020202020202020202020207c3e2064ff6963742e6765742876657273696f6e5f6f7261636c655f636f6e666967290a2020202020202020202020202020202020207c3e206f7074696f6e2e616e645f7468656e28646963742e676574285f2c202256657273696f6e206f7261636c652229290a2020202020202020202020202020202020207c3e206f7074696f6e2e69735f736f6d6528290a0a20202020202020202020202020207768656e206f75747075742e646174756d206973207b0a20202020202020202020202020202020496e6c696e65446174756d286461746129202d3e207b0a20202020202020202020202020202020202020206966206461746120697320646174756d3a20566572e773696f6e696e67446174756d207b0a20202020202020202020202020202020202020206861735f746f6b656e20262620646174756d2e7363726970744964203d3d2032390a2020202020202020202020202020202020207d20656c7365207b0a202020202020202020202020202020202020202046616c73650a2020202020202020202020202020202020207d0a2020202020202020202020202020202020207d0a202020202020202020202020202020205f202d3e2046616c73650a20202020202020202020202020207d0a2020202020202020202020207d2c0a202020202020202020202900168a99801a493365787065637420726573657276655f72656465656d65723a205265736572766552656465656d6572203d2072656465656d657200164888888889660026465300130130019809980a000cdc3a400530130024888966002600460266ea800e2646644a6602a9210648454c4c4f3500159800803c4cc88cc89660026006003159800980d9baa00b801403901c45660026012003159800980d9baa00b801403901c45660026008003159800980d9baa00b801403901c456600266e1d20060018acc004c06cdd5005c00a01c80e201c80c1018203040603300122259800801c006264b3001001801400a0051332259800800c012264b3001001802c01600b0058992cc004c09400e00f00640886eb80050251811000a040375a00260420090024088603e00680ea4603a603c603c0032598009801180c9baa0018a518a50405d374a900048966002601260346ea800a298103d87a8000898009bab301e301b375400480c244646600200200644b30010018a5eb8226644b3001300500289981080119802002000c4cc01001000501c18100009810800a03c9180e980f000a4444444664464b300100180bc4c966002605000519800912cc004c050c094dd50014400626eb8c0a4c098dd5001204691814181498149814800c89660026028604a6ea800a20031375a6052604c6ea800902348c0a0c0a4c0a4c0a4c0a400664660020026eb0c0a0c094dd5009112cc0040062980103d87a80008992cc004cdd7981518139baa0010128980599814800a5eb8226600600660560048120c0a400502724444464b30013012302937540051323259800980d18159baa001899912cc004c05cc0b4dd5000c4c96600200302481244cc8a6002005198009bae30343031375460686eb0c0d000a6eb8c048c0c4dd5181a1bac3034002998059980a198081bab300a3031375403c6eb8c0d0dd618091bac3034002233012001488100480026eb4c05cdd6181a0014966002603460626ea80062946294102f4888c8cc00400401089660020031004899801981c80099801001181d000a06e98181baa0219b87481012222222232598009811001c56600201d0338992cc004c0fc03e330013375e604260766ea8044c084c0ecdd5000ccc054cc078cc068dd5980e181d9baa00100a23301c00100a480026603a6eb0c070c0ecdd501411919912cc004c0a0c0f8dd5000c4cc8966002005001800c4ca6002003159800802c4c028dd69822800c528207e80120523758005001800a08c3042303f37540022942294103c1811198101980e1bab301e303d375400207246603c00291010e56657273696f6e206f7261636c65003023303d3754002603a60786ea800522259800800c0da264b300130430028acc0056600260146603c6eacc060c0fcdd50161980d980d181f9baa3020303f3754002a6607a921106d697373696e6720736372697074203200168a518a9981ea49176d696e7473476f7665726e616e6365203f2046616c73650014a081e22b3001598008024528c54cc0f524011d646174756d5f646f65735f6e6f745f6368616e6765203f2046616c73650014a081e22b30013371200c00714a3153303d4901356f75747075745f726573657276655f746f6b656e73203e3d20696e7075745f726573657276655f746f6b656e73203f2046616c73650014a081e2294103c4528207881ba080304100140fc81a2078303d00e40ed132598009814802456600201f0348992cc004c100042264b30013026303c375400313259800800c0e60731329800800c6600266e1ccdc080580619b8133019330223301e37566040607e6ea80100388cc0800040392000006acc004cdd798211bac304200130423758608402113375e60406eb0c108004c080dd6182100845282078998109bac3020303f37540584646644b3001302c30423754003133225980080140060031329800800c56600200b13370e6eb4c124005203c8a50410d00240b46eb000a0030014128608c60866ea800452845282080302633024330203756604460826ea80040f48cc08800522010e56657273696f6e206f7261636c6500302730413754002604260806ea800522259800800c0e2264b30013047002899192cc0040060791325980098250014566002b30010068a518a99822248122646174756d5f6368616e67655f6f6e6c795f62795f7374617473203f2046616c73650014a0821a2b300159800803c528c54cc11124012661737365745f6368616e67655f62795f636f72726563745f616d6f756e74203f2046616c73650014a0821a2b30013370e66e00cc080cc0a4cc094dd5981398231baa00101523302700101548000dd698139bac30273758609202e66e00cdc08098094c004cc0a0dd6182498231baa03323375e6094608e6ea8c128c11cdd5181418239baa001300d33049375200897ae0a4001223370000266044660566604e6eacc0a4c120dd5181498241baa002017233029001017480010104528c54cc111240129636f72726563745f616d6f756e745f7472616e736665727265645f746f5f696373203f2046616c73650014a0821a29410434528208681ea08e304800141186604c6eb0c0a8c110dd5018919baf3048304537546090608a6ea8004c02ccc11cdd480125eb80cc07cc078c10cdd5181218219baa001533041491106d697373696e67207363726970742033001681ca0883045001410c81d201e375800303981ca0863040303d375400303740e8604460786ea800606a81e8c0f803d03c45660026048009159800807c0d2264b300130400108992cc004c098c0f0dd5000c4c96600200303981cc4ca6002003198009980c998111980f1bab3020303f375400801c46604000201c900056600266ebcc108dd6182100098211bac3042010899b87375a604a6eb0c108004dd698129bac30420108a5040f13302137586040607e6ea80b08c8cc8966002605860846ea800626644b3001002800c00626530010018acc0040162601c6eb4c1240062941043400902d1bac002800c00504a182318219baa00114a114a08200c098cc090cc080dd5981118209baa00103d23302200148810e56657273696f6e206f7261636c6500302730413754002604260806ea800522259800800c0ea264b300130470028acc00566002601c660446eacc070c10cdd50181980f980f18219baa302430433754002a66082921106d697373696e6720736372697074203400168a518a99820a49176d696e7473476f7665726e616e6365203f2046616c73650014a082022b300159800801c528c54cc10524012d646174756d5f6368616e67655f6f6e6c795f62795f6d757461626c655f73657474696e6773203f2046616c73650014a082022b30013370e00801514a315330414901356f75747075745f726573657276655f746f6b656e73203d3d20696e7075745f726573657276655f746f6b656e73203f2046616c73650014a0820229410404528208081da0883045001410c81d201e375800303981ca0863040303d375400303740e8604460786ea800606a81e8c0f803d03c456600201f13259800800c0ca264b30013041002899192cc00400606d13259800982200144cc896600200303a8992cc004c11c00a2b3001598009807198111bab301c304337540606603e603c60866ea8c090c10cdd5000a99820a481106d697373696e6720736372697074203600168a518a99820a49176d696e7473476f7665726e616e6365203f2046616c73650014a082022b30015980080d4528c54cc10524011a6275726e735f726573657276655f61757468203f2046616c73650014a082022b30010038a518a99820a4812c616c6c5f726573657276655f746f6b656e735f7472616e7366657265645f746f5f696373203f2046616c73650014a0820229410404528208081da0883045001410c66e1ccdc04c004cc088dd6182198201baa02d23375e608860826ea8c110c104dd5181118209baa001300733043375200897ae0a40012233700002660386604a660426eacc08cc108dd5181198211baa0020112330230010114800100a0039980d198119980f9bab30213040375400201e46604200201e9000198111bac30213040375405a4646644b3001302d30433754003133225980080140060031329800800c56600200b1300f375a609400314a082220048170dd600140060028258c11cc110dd50008a508a504104604e6604a660426eacc08cc108dd500081f119811800a450e56657273696f6e206f7261636c6500302830423754002604460826ea800606e8208c108005040198101bac3024303e3754056466ebcc108c0fcdd51821181f9baa001300533041375200497ae0330193018303d3754603c607a6ea80054cc0ed2401106d697373696e672073637269707420350016819a07c303f00140f46603a6eb0c070c0ecdd501411919912cc004c0a0c0f8dd5000c4cc8966002005001800c4ca6002003159800802c4cdc39bad3045001480f2294103f40090291bac002800c0050461821181f9baa00114a114a081e0c088cc080cc070dd5980f181e9baa00103923301e00148810e56657273696f6e206f7261636c65003023303d3754002603a60786ea80062a660729211b657870656374205b5d203d20726573657276655f6f757470757473001640f081c10381ba548009037198099980e1980c1bab301a3039375401e0104660340020109000204c8008dd60009112cc00400e00313259800800c00a0051332259800800c01226644b300100180344c966002003007803c01e264b3001303d0038acc00401a01113259800800c4c96600200300a8992cc00400601700b899912cc00400601b13259800800c03a01d00e8992cc004c11000e2b30013028303f375400f13259800800c042264b3001001808c046023011899912cc00400602713259800800c05202901480a44c96600260940071598008054056264b300100180b405a02d016899912cc00400603113259800800c0660330198992cc004c13c00e03701a41306eb40060328278c13000504a1bae001304b00b41306092014823a02a8238dd7000a094304700141146eb8004c1180090471822000a0843040375400f00f40f500f41046eb400601c8220c10400503f1bac0013040002805c02d041181f000a078303e007804c02601300940fc607800c81d201081d0dd6800c01d03d181d000a0703038001303900140d86eb0004c0dc01200500240e0606a006819a04902440d06062605c6ea80062a6605892013265787065637420496e6c696e65446174756d28696e7075745f646174756d29203d20696e7075745f7574786f2e646174756d001640ac664466020004464b3001301e302f375400313371e0066eb8c0ccc0c0dd5000c528205a3032302f37546064605e6ea8004dd6180918161baa019375c605e60586ea8004c048c0b0dd5001454cc0a924014a6578706563742053637269707428726573657276655f7363726970745f6861736829203d20696e7075745f7574786f2e616464726573732e7061796d656e745f63726564656e7469616c001640a4605c60566ea8c0b8c0acdd5000980598151baa302d302a3754005153302849014e65787065637420536f6d6528696e70757429203d0a20202020202073656c662e696e707574730a20202020202020207c3e207472616e73616374696f6e2e66696e645f696e707574287574786f290016409c66e1d2001330033300c330083756600460526ea8058cc014c010c0a4dd5180518149baa0065330274901106d697373696e67207363726970742031001623300a00148900480010184094604c0028120cc010dd6180198111baa00f232332259800980798129baa001899912cc00400a0030018994c0040062b3001005899b87375a6058002901d4528204c80120203758005001800a05a30293026375400229422941023180499803998019bab30053024375400204046600a0029110e56657273696f6e206f7261636c6500300a30243754002600860466ea800488c8cc00400400c896600200314c0103d87a8000899192cc004cdc8802800c56600266e3c0140062601466050604c00497ae08a60103d87a8000408d133004004302a003408c6eb8c090004c09c005025111919800800801912cc0040062980103d87a8000899192cc004cdc8802800c56600266e3c0140062601466050604c00497ae08a60103d87a8000408d133004004302a003408c6eb8c090004c09c0050250c060dd50049b8748010dc3a400100a805402a01480e0c060004c060c064004c050dd5001c590110c04c004c038dd500a45268a998062491856616c696461746f722072657475726e65642066616c73650013656402c1"
	));

	let reserve_validator_script =
		plutus_script_v3![reserve_validator_raw_script, version_oracle.policy_id_as_plutus_data()]?;
	let reserve_validator = ScriptData::new_v3(
		"Reserve Management Validator",
		reserve_validator_script.bytes.to_vec(),
		ScriptId::ReserveValidator,
	);

	let auth_policy =
		plutus_script![RESERVE_AUTH_POLICY, version_oracle.policy_id_as_plutus_data()]?;
	let reserve_policy = ScriptData::new(
		"Reserve Management Policy",
		auth_policy.bytes.to_vec(),
		ScriptId::ReserveAuthPolicy,
	);
	Ok(vec![
		initialize_script(reserve_validator, genesis_utxo, payment_key, client, await_tx).await?,
		initialize_script(reserve_policy, genesis_utxo, payment_key, client, await_tx).await?,
	]
	.into_iter()
	.flatten()
	.collect())
}
