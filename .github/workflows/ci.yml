name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - master
jobs:
  build:
    runs-on: nixos
    steps:
      - name: cache cargo build
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry/
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: build
        run: nix develop -c bash -c "cargo build --locked --profile=release"

      - name: test
        run: nix develop -c bash -c "cargo test --locked --profile=release --features=runtime-benchmarks"

      - name: lint
        run: nix develop -c bash -c "RUSTFLAGS=-Dwarnings cargo clippy --all-targets --all-features"

      - name: formatting
        run: nix develop -c bash -c "cargo fmt --check"

      - name: build docker image
        run: |
          cp target/release/partner-chains-demo-node .
          nix develop -c bash -c "patchelf --set-interpreter /lib64/ld-linux-x86-64.so.2 partner-chains-demo-node"
          docker build -t partner-chains-node:local .

      - name: build chain specs
        run: |
          source dev/envs/devnet/.envrc
          target/release/partner-chains-demo-node build-spec --chain local --disable-default-bootnode > devnet_chain_spec.json

          source dev/envs/ci-preview/.envrc
          target/release/partner-chains-demo-node build-spec --chain local --disable-default-bootnode > ci_preview_chain_spec.json

          source dev/envs/staging-preview/.envrc
          target/release/partner-chains-demo-node build-spec --chain local --disable-default-bootnode > staging_preview_chain_spec.json
