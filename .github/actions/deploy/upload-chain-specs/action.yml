name: Upload Chain Spec Artifacts to Kubernetes PVC
description: Uploads chain‑spec artifacts to PVCs for devnet, staging‑preview and staging‑preprod.

inputs:
  sha:
    description: Commit SHA to append to chain‑spec file
    required: true

outputs: {}

runs:
  using: composite
  steps:
    - name: Install kubectl and awscli
      shell: bash
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x ./kubectl && sudo mv ./kubectl /usr/local/bin/kubectl

        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o awscliv2.zip
        unzip -o awscliv2.zip
        sudo ./aws/install --update

    - name: Configure kubectl
      shell: bash
      env:
        KUBECONFIG_BASE64: ${{ env.kubeconfig_base64 }}
        K8S_SERVER:       ${{ env.K8S_SERVER }}
        K8S_SA_TOKEN:     ${{ env.K8S_SA_TOKEN }}
      run: |
        echo "$KUBECONFIG_BASE64" | base64 --decode > "$RUNNER_TEMP/kubeconfig.yaml"
        export KUBECONFIG="$RUNNER_TEMP/kubeconfig.yaml"
        kubectl config set-cluster my-cluster --server="$K8S_SERVER" --insecure-skip-tls-verify
        kubectl config set-credentials github-actions --token="$K8S_SA_TOKEN"
        kubectl config set-context my-context --cluster=my-cluster --user=github-actions --namespace=default
        kubectl config use-context my-context

    - name: Download chain‑spec artifacts
      uses: actions/download-artifact@v4
      with:
        name: chain-specs

    - name: Upload chain‑spec artifacts to PVCs
      shell: bash
      run: |
        JSON_OVERRIDE='{
          "spec":{
            "containers":[{
              "name":"uploader",
              "image":"alpine",
              "command":["sleep","600"],
              "volumeMounts":[{"name":"chain-spec","mountPath":"/mnt/chain-spec"}]
            }],
            "volumes":[{"name":"chain-spec","persistentVolumeClaim":{"claimName":"chain-spec-pvc"}}]
          }
        }'

        # -------- devnet / sc --------
        POD=sc                         # namespace
        kubectl run pvc-uploader-sc -n "$POD" --restart=Never --image=alpine --command --overrides="$JSON_OVERRIDE" -- sleep 600
        kubectl wait --for=condition=Ready pod/pvc-uploader-sc -n "$POD" --timeout=60s
        if [ -f ./devnet_chain_spec.json ]; then
          kubectl cp ./devnet_chain_spec.json "$POD"/pvc-uploader-sc:/mnt/chain-spec/devnet-chain-spec-${{ inputs.sha }}.json
        fi
        kubectl delete pod pvc-uploader-sc -n "$POD" --wait

        # -------- ci-preview --------
        POD=ci-preview
        kubectl run pvc-uploader-ci-preview -n "$POD" --restart=Never --image=alpine --command --overrides="$JSON_OVERRIDE" -- sleep 600
        kubectl wait --for=condition=Ready pod/pvc-uploader-ci-preview -n "$POD" --timeout=60s
        if [ -f ./ci_preview_chain_spec.json ]; then
          kubectl cp ./ci_preview_chain_spec.json "$POD"/pvc-uploader-ci-preview:/mnt/chain-spec/ci-preview-chain-spec-${{ inputs.sha }}.json
        fi
        kubectl delete pod pvc-uploader-ci-preview -n "$POD" --wait

        # -------- staging-preview --------
        POD=staging-preview
        kubectl run pvc-uploader-staging-preview -n "$POD" --restart=Never --image=alpine --command --overrides="$JSON_OVERRIDE" -- sleep 600
        kubectl wait --for=condition=Ready pod/pvc-uploader-staging-preview -n "$POD" --timeout=60s
        if [ -f ./staging_preview_chain_spec.json ]; then
          kubectl cp ./staging_preview_chain_spec.json "$POD"/pvc-uploader-staging-preview:/mnt/chain-spec/staging-preview-chain-spec-${{ inputs.sha }}.json
        fi
        kubectl delete pod pvc-uploader-staging-preview -n "$POD" --wait

        # -------- staging-preprod --------
        POD=staging-preprod
        kubectl run pvc-uploader-staging-preprod -n "$POD" --restart=Never --image=alpine --command --overrides="$JSON_OVERRIDE" -- sleep 600
        kubectl wait --for=condition=Ready pod/pvc-uploader-staging-preprod -n "$POD" --timeout=60s
        if [ -f ./staging_preprod_chain_spec.json ]; then
          kubectl cp ./staging_preprod_chain_spec.json "$POD"/pvc-uploader-staging-preprod:/mnt/chain-spec/staging-preprod-chain-spec-${{ inputs.sha }}.json
        fi
        kubectl delete pod pvc-uploader-staging-preprod -n "$POD" --wait

    - name: Cleanup temp uploader pods
      shell: bash
      run: |
        kubectl delete pod pvc-uploader-sc              -n sc              --ignore-not-found --wait
        kubectl delete pod pvc-uploader-ci-preview      -n ci-preview      --ignore-not-found --wait
        kubectl delete pod pvc-uploader-staging-preview -n staging-preview --ignore-not-found --wait
        kubectl delete pod pvc-uploader-staging-preprod -n staging-preprod --ignore-not-found --wait
