name: "Teardown ArgoCD Environment"
description: "Tears down an ArgoCD environment by removing an ephemeral environment file."
inputs:
  sha:
    description: "SHA of the commit"
    required: true

outputs: {}

runs:
  using: "composite"
  steps:
    - name: Checkout ArgoCD Repository
      uses: actions/checkout@v4
      with:
        repository: input-output-hk/sidechains-argocd
        token: ${{ env.ACTIONS_PAT }}
        path: sidechains-argocd

    - name: Delete Ephemeral Environment File
      uses: actions/github-script@v7
      with:
        github-token: ${{ env.ACTIONS_PAT }}
        script: |
          const fs = require('fs');
          const path = require('path');

          const directory = 'sidechains-argocd/integration-testing';
          const targetFile = `manifest-sha-${{ inputs.sha }}.yaml`;
          const filePath = path.join(directory, targetFile);

          if (fs.existsSync(filePath)) {
            console.log(`Deleting file: ${targetFile}`);

            const shaResponse = await github.rest.repos.getContent({
              owner: 'input-output-hk',
              repo: 'sidechains-argocd',
              path: `integration-testing/${targetFile}`,
            });
            const fileSha = shaResponse.data.sha;

            await github.rest.repos.deleteFile({
              owner: 'input-output-hk',
              repo: 'sidechains-argocd',
              path: `integration-testing/${targetFile}`,
              message: `ci: Tear down integration-testing environment for SHA ${{ inputs.sha }}`,
              sha: fileSha,
              branch: 'main'
            });
          } else {
            console.log(`File not found: ${targetFile}`);
          }
