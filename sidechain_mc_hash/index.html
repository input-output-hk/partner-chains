<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Crate implementing a mechanism for Partner Chain blocks to reference a stable Cardano main chain block."><title>sidechain_mc_hash - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-6b053e98.ttf.woff2,FiraSans-Italic-81dc35de.woff2,FiraSans-Regular-0fe48ade.woff2,FiraSans-MediumItalic-ccf7e434.woff2,FiraSans-Medium-e1aa3f0a.woff2,SourceCodePro-Regular-8badfe75.ttf.woff2,SourceCodePro-Semibold-aa29a496.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../static.files/normalize-9960930a.css"><link rel="stylesheet" href="../static.files/rustdoc-0ce1a80b.css"><meta name="rustdoc-vars" data-root-path="../" data-static-root-path="../static.files/" data-current-crate="sidechain_mc_hash" data-themes="" data-resource-suffix="" data-rustdoc-version="1.89.0-nightly (414482f6a 2025-05-13)" data-channel="nightly" data-search-js="search-f7877310.js" data-settings-js="settings-5514c975.js" ><script src="../static.files/storage-4e99c027.js"></script><script defer src="../crates.js"></script><script defer src="../static.files/main-7ef8a74a.js"></script><noscript><link rel="stylesheet" href="../static.files/noscript-32bb7600.css"></noscript><link rel="alternate icon" type="image/png" href="../static.files/favicon-32x32-6580c154.png"><link rel="icon" type="image/svg+xml" href="../static.files/favicon-044be391.svg"></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../sidechain_mc_hash/index.html">sidechain_<wbr>mc_<wbr>hash</a><span class="version">1.6.0</span></h2></div><div class="sidebar-elems"><ul class="block"><li><a id="all-types" href="all.html">All Items</a></li></ul><section id="rustdoc-toc"><h3><a href="#">Sections</a></h3><ul class="block top-toc"><li><a href="#purpose-of-this-crate" title="Purpose of this crate">Purpose of this crate</a></li><li><a href="#prerequisites" title="Prerequisites">Prerequisites</a></li><li><a href="#adding-to-the-node" title="Adding to the node">Adding to the node</a><ul><li><a href="#data-source" title="Data source">Data source</a></li><li><a href="#adding-the-inherent-data-provider" title="Adding the inherent data provider">Adding the inherent data provider</a></li><li><a href="#import-queue-configuration" title="Import queue configuration">Import queue configuration</a></li></ul></li></ul><h3><a href="#modules">Crate Items</a></h3><ul class="block"><li><a href="#modules" title="Modules">Modules</a></li><li><a href="#structs" title="Structs">Structs</a></li><li><a href="#enums" title="Enums">Enums</a></li><li><a href="#constants" title="Constants">Constants</a></li><li><a href="#traits" title="Traits">Traits</a></li><li><a href="#functions" title="Functions">Functions</a></li></ul></section><div id="rustdoc-modnav"></div></div></nav><div class="sidebar-resizer" title="Drag to resize sidebar"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Crate <span>sidechain_mc_hash</span><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><rustdoc-toolbar></rustdoc-toolbar><span class="sub-heading"><a class="src" href="../src/sidechain_mc_hash/lib.rs.html#1-635">Source</a> </span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Crate implementing a mechanism for Partner Chain blocks to reference a stable Cardano main chain block.</p>
<h2 id="purpose-of-this-crate"><a class="doc-anchor" href="#purpose-of-this-crate">§</a>Purpose of this crate</h2>
<p>This crate provides a base for all other Partner Chain Toolkit’s features that require Cardano observability.
Whenever some part of Cardano state is observed and included in a Partner Chain’s own state, all Partner Chain
nodes need to agree on what data was eligible for inclusion when a PC block was produced. This is
best achieved by first agreeing on a stable Cardano block which then serves as the upper boundary of all observed
Cardano data. This <em>main chain reference block</em> is selected by the block producing node and must be accepted by
other nodes as being stable at the time of block production.</p>
<p>This crate implements the [InherentDataProvider] and <a href="../sp_partner_chains_consensus_aura/inherent_digest/trait.InherentDigest.html" title="trait sp_partner_chains_consensus_aura::inherent_digest::InherentDigest">InherentDigest</a> mechanism for selecting a reference main
chain block as part of inherent data creation step and saving it as a <em>main chain reference hash</em> in the block
header.</p>
<h2 id="prerequisites"><a class="doc-anchor" href="#prerequisites">§</a>Prerequisites</h2>
<p>This feature uses the <a href="../sp_partner_chains_consensus_aura/inherent_digest/trait.InherentDigest.html" title="trait sp_partner_chains_consensus_aura::inherent_digest::InherentDigest">InherentDigest</a> mechanism from <a href="../sp_partner_chains_consensus_aura/index.html" title="mod sp_partner_chains_consensus_aura">sp_partner_chains_consensus_aura</a> crate for storing inherent
data in the block header. Your node must use the <a href="../sp_partner_chains_consensus_aura/block_proposal/struct.PartnerChainsProposer.html" title="struct sp_partner_chains_consensus_aura::block_proposal::PartnerChainsProposer">PartnerChainsProposer</a> defined by that crate for this feature to work.</p>
<h2 id="adding-to-the-node"><a class="doc-anchor" href="#adding-to-the-node">§</a>Adding to the node</h2>
<p>To add the feature to your Partner Chain node, follow the instructions below.
Refer to the demo node implementation for reference.</p>
<h3 id="data-source"><a class="doc-anchor" href="#data-source">§</a>Data source</h3>
<p>A data source implementing the <a href="trait.McHashDataSource.html" title="trait sidechain_mc_hash::McHashDataSource">McHashDataSource</a> interface trait should be added to your node. A Db-Sync
implementation can be found in the <code>partner-chains-db-sync-data-sources</code> crate. Refer to its documentation on
how to configure and use it.</p>
<h3 id="adding-the-inherent-data-provider"><a class="doc-anchor" href="#adding-the-inherent-data-provider">§</a>Adding the inherent data provider</h3>
<p><a href="struct.McHashInherentDataProvider.html" title="struct sidechain_mc_hash::McHashInherentDataProvider">McHashInherentDataProvider</a> should be added to your inherent data provider stack for both block proposal and
verification, using dedicated constructor for each.</p>
<p>The main chain reference hash provided by <a href="struct.McHashInherentDataProvider.html" title="struct sidechain_mc_hash::McHashInherentDataProvider">McHashInherentDataProvider</a> is meant to be used by other inherent data
providers from the Partner Chains Toolkit which require Cardano observability. As such, it should be created first in
your node’s IDP stack, so that <a href="struct.McHashInherentDataProvider.html#method.mc_hash" title="method sidechain_mc_hash::McHashInherentDataProvider::mc_hash">McHashInherentDataProvider::mc_hash</a> and <a href="struct.McHashInherentDataProvider.html#method.previous_mc_hash" title="method sidechain_mc_hash::McHashInherentDataProvider::previous_mc_hash">McHashInherentDataProvider::previous_mc_hash</a>
can be used to pass the reference hashes to other IDPs.</p>
<p>As an example, creation for proposal would look like the following:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>sp_consensus_slots::{Slot, SlotDuration};
<span class="kw">use </span>sp_runtime::traits::Block <span class="kw">as </span>BlockT;

<span class="kw">struct </span>ProposalCIDP {
    <span class="comment">// the data source should be created as part of your node's setup
    </span>mc_hash_data_source: Arc&lt;<span class="kw">dyn </span>McHashDataSource + Send + Sync&gt;,
    <span class="comment">// slot duration should either be a part of your node's configuration or be
    // retrieved using `parent_hash` and your consensus mechanism's runtime API
    </span>slot_duration: SlotDuration,
}

<span class="attr">#[async_trait::async_trait]
</span><span class="kw">impl</span>&lt;Block&gt; sp_inherents::CreateInherentDataProviders&lt;Block, ()&gt; <span class="kw">for </span>ProposalCIDP
<span class="kw">where
    </span>Block: BlockT + Send + Sync
{
    <span class="kw">type </span>InherentDataProviders = McHashInherentDataProvider;

    <span class="kw">async fn </span>create_inherent_data_providers(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        parent_hash: &lt;Block <span class="kw">as </span>BlockT&gt;::Hash,
        _extra_args: (),
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="self">Self</span>::InherentDataProviders, Box&lt;<span class="kw">dyn </span>std::error::Error + Send + Sync&gt;&gt; {
        <span class="kw">let </span>parent_header: &lt;Block <span class="kw">as </span>BlockT&gt;::Header = <span class="macro">unimplemented!</span>(<span class="string">"Retrieved from block store"</span>);
        <span class="kw">let </span>slot: Slot = <span class="macro">unimplemented!</span>(<span class="string">"Provided by the consensus IDP"</span>);

        <span class="kw">let </span>mc_hash = McHashInherentDataProvider::new_proposal(
            parent_header,
            <span class="self">self</span>.mc_hash_data_source.as_ref(),
            slot,
            <span class="self">self</span>.slot_duration,
        ).<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="comment">// Other providers can now use mc_hash.mc_hash() and mc_hash.previous_mc_hash()

        </span><span class="prelude-val">Ok</span>((mc_hash <span class="comment">/* other inherent data providers */</span>))
    }
}</code></pre></div>
<p>For block validation, creation of the IDP would look like this:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>sidechain_domain::McBlockHash;

<span class="kw">struct </span>VerificationIDP {
    <span class="comment">// the data source should be created as part of your node's setup
    </span>mc_hash_data_source: Arc&lt;<span class="kw">dyn </span>McHashDataSource + Send + Sync&gt;,
    <span class="comment">// slot duration should either be a part of your node's configuration or be
    // retrieved using `parent_hash` and your consensus mechanism's runtime API
    </span>slot_duration: SlotDuration,
}

<span class="attr">#[async_trait::async_trait]
</span><span class="kw">impl</span>&lt;Block&gt; sp_inherents::CreateInherentDataProviders&lt;Block, (Slot, McBlockHash)&gt; <span class="kw">for </span>VerificationIDP
<span class="kw">where
    </span>Block: BlockT + Send + Sync
{
    <span class="kw">type </span>InherentDataProviders = McHashInherentDataProvider;

    <span class="kw">async fn </span>create_inherent_data_providers(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        parent_hash: &lt;Block <span class="kw">as </span>BlockT&gt;::Hash,
        (block_slot_from_header, mc_hash_from_header): (Slot, McBlockHash),
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="self">Self</span>::InherentDataProviders, Box&lt;<span class="kw">dyn </span>std::error::Error + Send + Sync&gt;&gt; {
        <span class="kw">let </span>parent_header: &lt;Block <span class="kw">as </span>BlockT&gt;::Header = <span class="macro">unimplemented!</span>(<span class="string">"Retrieved from block store"</span>);
        <span class="kw">let </span>slot: Slot = <span class="macro">unimplemented!</span>(<span class="string">"Provided by the consensus IDP"</span>);
        <span class="kw">let </span>parent_slot: <span class="prelude-ty">Option</span>&lt;Slot&gt; = <span class="macro">unimplemented!</span>(<span class="string">"Read from previous block using runtime API"</span>);

        <span class="kw">let </span>mc_hash = McHashInherentDataProvider::new_verification(
            parent_header,
            parent_slot,
            block_slot_from_header,
            mc_hash_from_header,
            <span class="self">self</span>.slot_duration,
            <span class="self">self</span>.mc_hash_data_source.as_ref(),
        )
        .<span class="kw">await</span><span class="question-mark">?</span>;

        <span class="comment">// Other providers can now use mc_hash.mc_hash() and mc_hash.previous_mc_hash()

        </span><span class="prelude-val">Ok</span>((mc_hash <span class="comment">/* other inherent data providers */</span>))
    }
}</code></pre></div>
<p>Note that for verification the implementation now accepts additional arguments of types [Slot] and <a href="../sidechain_domain/struct.McBlockHash.html" title="struct sidechain_domain::McBlockHash">McBlockHash</a>
which are provided by the import queue based on the header. In this case, the <a href="../sidechain_domain/struct.McBlockHash.html" title="struct sidechain_domain::McBlockHash">McBlockHash</a> value comes from the
<a href="../sp_partner_chains_consensus_aura/inherent_digest/trait.InherentDigest.html" title="trait sp_partner_chains_consensus_aura::inherent_digest::InherentDigest">InherentDigest</a> defined in next section.</p>
<h3 id="import-queue-configuration"><a class="doc-anchor" href="#import-queue-configuration">§</a>Import queue configuration</h3>
<p>To be able to save and retrieve inherent data in the block header, your node should use the <a href="../sp_partner_chains_consensus_aura/block_proposal/struct.PartnerChainsProposer.html" title="struct sp_partner_chains_consensus_aura::block_proposal::PartnerChainsProposer">PartnerChainsProposer</a>
instead of the stock proposer provided by Substrate. Refer to its documentation for more information.</p>
<p>For this feature to work, the only modification needed is to set <a href="struct.McHashInherentDigest.html" title="struct sidechain_mc_hash::McHashInherentDigest">McHashInherentDigest</a> as the inherent digest
type of the proposer. This will cause it to save the inherent data provided by <a href="struct.McHashInherentDataProvider.html" title="struct sidechain_mc_hash::McHashInherentDataProvider">McHashInherentDataProvider</a> to be
also saved in the block header and available for inspection and verification. Assuming your node uses
<a href="../sp_partner_chains_consensus_aura/block_proposal/struct.PartnerChainsProposerFactory.html" title="struct sp_partner_chains_consensus_aura::block_proposal::PartnerChainsProposerFactory">PartnerChainsProposerFactory</a>, this should look like the following:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use </span>sidechain_mc_hash::McHashInherentDigest;
<span class="kw">use </span>sp_consensus::Environment;
<span class="kw">use </span>sp_partner_chains_consensus_aura::block_proposal::PartnerChainsProposerFactory;
<span class="kw">use </span>sp_runtime::traits::Block <span class="kw">as </span>BlockT;

<span class="kw">fn </span>new_full&lt;Block: BlockT, ProposerFactory: Environment&lt;Block&gt;&gt;(
	base_proposer_factory: ProposerFactory,
) {
    <span class="comment">// .. other node setup logic
	</span><span class="kw">let </span>proposer_factory: PartnerChainsProposerFactory&lt;
		Block,
		ProposerFactory,
		McHashInherentDigest,
	&gt; = PartnerChainsProposerFactory::new(base_proposer_factory);
    <span class="comment">// ..
</span>}</code></pre></div>
</div></details><h2 id="modules" class="section-header">Modules<a href="#modules" class="anchor">§</a></h2><dl class="item-table"><dt><a class="mod" href="mock/index.html" title="mod sidechain_mc_hash::mock">mock</a></dt><dd>Mock implementations of components in this crate for use in tests</dd></dl><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><dl class="item-table"><dt><a class="struct" href="struct.McHashInherentDataProvider.html" title="struct sidechain_mc_hash::McHashInherentDataProvider">McHash<wbr>Inherent<wbr>Data<wbr>Provider</a></dt><dd>Inherent data provider that provides the hash of the latest stable Cardano block
(main chain reference block) observed by the block producer to be included in the
header of the currently produced PC block.</dd><dt><a class="struct" href="struct.McHashInherentDigest.html" title="struct sidechain_mc_hash::McHashInherentDigest">McHash<wbr>Inherent<wbr>Digest</a></dt><dd><a href="../sp_partner_chains_consensus_aura/inherent_digest/trait.InherentDigest.html" title="trait sp_partner_chains_consensus_aura::inherent_digest::InherentDigest">InherentDigest</a> implementation for the main chain reference hash</dd></dl><h2 id="enums" class="section-header">Enums<a href="#enums" class="anchor">§</a></h2><dl class="item-table"><dt><a class="enum" href="enum.McHashInherentError.html" title="enum sidechain_mc_hash::McHashInherentError">McHash<wbr>Inherent<wbr>Error</a></dt><dd>Error type returned by constructors of <a href="struct.McHashInherentDataProvider.html" title="struct sidechain_mc_hash::McHashInherentDataProvider">McHashInherentDataProvider</a></dd></dl><h2 id="constants" class="section-header">Constants<a href="#constants" class="anchor">§</a></h2><dl class="item-table"><dt><a class="constant" href="constant.INHERENT_IDENTIFIER.html" title="constant sidechain_mc_hash::INHERENT_IDENTIFIER">INHERENT_<wbr>IDENTIFIER</a></dt><dd>Inherent identifier under which the main chain block reference is provided</dd><dt><a class="constant" href="constant.MC_HASH_DIGEST_ID.html" title="constant sidechain_mc_hash::MC_HASH_DIGEST_ID">MC_<wbr>HASH_<wbr>DIGEST_<wbr>ID</a></dt><dd>Digest ID of the main chain reference block hash</dd></dl><h2 id="traits" class="section-header">Traits<a href="#traits" class="anchor">§</a></h2><dl class="item-table"><dt><a class="trait" href="trait.McHashDataSource.html" title="trait sidechain_mc_hash::McHashDataSource">McHash<wbr>Data<wbr>Source</a></dt><dd>Data source API used by <a href="struct.McHashInherentDataProvider.html" title="struct sidechain_mc_hash::McHashInherentDataProvider">McHashInherentDataProvider</a></dd></dl><h2 id="functions" class="section-header">Functions<a href="#functions" class="anchor">§</a></h2><dl class="item-table"><dt><a class="fn" href="fn.get_inherent_digest_value_for_block.html" title="fn sidechain_mc_hash::get_inherent_digest_value_for_block">get_<wbr>inherent_<wbr>digest_<wbr>value_<wbr>for_<wbr>block</a></dt><dt><a class="fn" href="fn.get_mc_hash_for_block.html" title="fn sidechain_mc_hash::get_mc_hash_for_block">get_<wbr>mc_<wbr>hash_<wbr>for_<wbr>block</a></dt></dl></section></div></main></body></html>